{% extends "base.html" %}

{% block title %}Procesar Pago - EventLink{% endblock %}

{% block extra_css %}
<style>
    /* Estilos EventLink para la pasarela de pago */
    .pago-container {
        background: var(--eventlink-gray-lightest);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    #form-checkout {
        display: flex;
        flex-direction: column;
        max-width: 600px;
    }

    .mp-container {
        height: 40px;
        display: inline-block;
        border: 1px solid var(--eventlink-gray-lighter);
        border-radius: var(--radius-md);
        padding: 0.375rem 0.75rem;
        background-color: var(--eventlink-white);
        transition: var(--transition);
    }
    
    .mp-container:focus-within {
        border-color: var(--eventlink-blue);
        box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
    }
    
    .pago-card {
        background: var(--eventlink-white);
        border: 1px solid var(--eventlink-gray-lighter);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }
    
    .pago-card-header {
        background: var(--eventlink-blue);
        color: var(--eventlink-white);
        padding: 1.5rem;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    .pago-card-header h3 {
        margin: 0;
        font-weight: 600;
        font-size: 1.5rem;
    }
    
    .pago-card-body {
        padding: 2rem;
    }
    
    .alert-info {
        background: var(--eventlink-blue-lighter);
        border: 1px solid var(--eventlink-blue-light);
        color: var(--eventlink-navy);
        border-radius: var(--radius-md);
    }
    
    .btn-pago {
        background: var(--eventlink-blue);
        color: var(--eventlink-white);
        border: none;
        padding: 1rem 2rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 1.1rem;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .btn-pago:hover {
        background: var(--eventlink-blue-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .btn-pago:disabled {
        background: var(--eventlink-gray-light);
        cursor: not-allowed;
        transform: none;
    }
    
    .form-label {
        font-weight: 600;
        color: var(--eventlink-navy);
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border: 1px solid var(--eventlink-gray-lighter);
        border-radius: var(--radius-md);
        padding: 0.75rem;
        transition: var(--transition);
    }
    
    .form-control:focus {
        border-color: var(--eventlink-blue);
        box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
    }
    
    .progress-bar {
        background: var(--eventlink-gray-lighter);
        border-radius: var(--radius-md);
        overflow: hidden;
    }
    
    .progress-bar::-webkit-progress-value {
        background: var(--eventlink-blue);
    }
    
    .alert-danger {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        border-radius: var(--radius-md);
    }
    
    .alert-success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #16a34a;
        border-radius: var(--radius-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="pago-container">
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="pago-card">
                    <div class="pago-card-header">
                        <h3><i class="fas fa-credit-card"></i> Procesar Pago</h3>
                    </div>
                    <div class="pago-card-body">
                    
                    <!-- Resumen del pago -->
                    <div class="alert alert-info">
                        {% if contratacion %}
                            <h5>Resumen del Servicio</h5>
                            <p><strong>Servicio:</strong> {{ contratacion.servicio.nombre }}</p>
                            <p><strong>Evento:</strong> {{ contratacion.evento.titulo }}</p>
                            <h6><strong>Total a Pagar: ${{ "%.2f"|format(contratacion.precio_total) }}</strong></h6>
                        {% endif %}
                    </div>
                    
                    <!-- Informaci√≥n de prueba -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Modo de Prueba - Tarjetas Oficiales de MercadoPago</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>‚úÖ Mastercard (Aprobada):</strong><br>
                                <small>5254 1336 7440 3564<br>CVV: 123 | Vencimiento: 11/30</small>
                            </div>
                            <div class="col-md-6">
                                <strong>‚úÖ Visa (Aprobada):</strong><br>
                                <small>4013 5406 8274 6260<br>CVV: 123 | Vencimiento: 11/30</small>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <strong>‚ùå American Express (Rechazada):</strong><br>
                                <small>3743 781877 55283<br>CVV: 1234 | Vencimiento: 11/30</small>
                            </div>
                            <div class="col-md-6">
                                <strong>üí≥ Visa D√©bito:</strong><br>
                                <small>4915 1120 5524 6507<br>CVV: 123 | Vencimiento: 11/30</small>
                            </div>
                        </div>
                        <p class="mt-2 mb-0"><strong>Nota:</strong> Usa <code>APRO</code> como nombre para pagos aprobados, <code>FUND</code> para rechazados.</p>
                    </div>

                    <!-- Formulario de pago -->
                    <form id="form-checkout">
                        <div class="mb-3">
                            <label for="form-checkout__cardNumber" class="form-label">N√∫mero de tarjeta</label>
                            <div id="form-checkout__cardNumber" class="mp-container"></div>
                        </div>

                        <div class="mb-3">
                            <label for="form-checkout__expirationDate" class="form-label">Fecha de vencimiento</label>
                            <div id="form-checkout__expirationDate" class="mp-container"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="form-checkout__securityCode" class="form-label">C√≥digo de seguridad (CVV)</label>
                            <div id="form-checkout__securityCode" class="mp-container"></div>
                        </div>

                        <div class="mb-3">
                            <label for="form-checkout__cardholderName" class="form-label">Nombre del titular</label>
                            <input type="text" id="form-checkout__cardholderName" class="form-control" 
                                   value="{{ session.user_nombre or 'Test User' }}" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="form-checkout__cardholderEmail" class="form-label">Email</label>
                            <input type="email" id="form-checkout__cardholderEmail" class="form-control" 
                                   value="{{ session.user_correo or 'test@test.com' }}" />
                        </div>

                        <div class="mb-3">
                            <label for="form-checkout__issuer" class="form-label">Banco emisor</label>
                            <select id="form-checkout__issuer" class="form-control"></select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="form-checkout__installments" class="form-label">Cuotas</label>
                            <select id="form-checkout__installments" class="form-control"></select>
                        </div>

                        <div class="mb-3">
                            <label for="form-checkout__identificationType" class="form-label">Tipo de documento</label>
                            <select id="form-checkout__identificationType" class="form-control"></select>
                        </div>

                        <div class="mb-3">
                            <label for="form-checkout__identificationNumber" class="form-label">N√∫mero de documento</label>
                            <input type="text" id="form-checkout__identificationNumber" class="form-control" 
                                   placeholder="N√∫mero de documento" />
                        </div>
                        
                        <button type="submit" id="form-checkout__submit" class="btn-pago w-100">
                            <i class="fas fa-credit-card"></i> 
                            Pagar ${{ "%.2f"|format(contratacion.precio_total if contratacion else total) }}
                        </button>
                        
                        <progress value="0" class="progress-bar mt-3" style="width: 100%; height: 20px;">Cargando...</progress>
                    </form>

                    <!-- Mensajes -->
                    <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="success-message" class="alert alert-success mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ Cargar MercadoPago SDK UNA SOLA VEZ -->
<script src="{{ url_for('static', filename='js/mercadopago-loader.js') }}"></script>

<script>
console.log('üöÄ Iniciando script de pago...');

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ DOM cargado, inicializando MercadoPago...');
    
    // Funciones auxiliares
    function showError(message) {
        console.error('üö® Error:', message);
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        if (successDiv) successDiv.style.display = 'none';
    }

    function showSuccess(message) {
        console.log('‚úÖ √âxito:', message);
        const successDiv = document.getElementById('success-message');
        const errorDiv = document.getElementById('error-message');
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        if (errorDiv) errorDiv.style.display = 'none';
    }
    
    try {
        // ‚úÖ Cargar MercadoPago usando el singleton
        const mp = await window.loadMercadoPago("TEST-f337044d-548b-4395-8b18-ee976a52ea42");
        console.log('‚úÖ MercadoPago listo');

        // Configurar el formulario de tarjeta
        const cardForm = mp.cardForm({
            amount: "{{ contratacion.precio_total if contratacion else 100 }}",
            iframe: true,
            form: {
                id: "form-checkout",
                cardNumber: { id: "form-checkout__cardNumber", placeholder: "N√∫mero de tarjeta" },
                expirationDate: { id: "form-checkout__expirationDate", placeholder: "MM/YY" },
                securityCode: { id: "form-checkout__securityCode", placeholder: "C√≥digo de seguridad" },
                cardholderName: { id: "form-checkout__cardholderName", placeholder: "Titular de la tarjeta" },
                issuer: { id: "form-checkout__issuer", placeholder: "Banco emisor" },
                installments: { id: "form-checkout__installments", placeholder: "Cuotas" },
                identificationType: { id: "form-checkout__identificationType", placeholder: "Tipo de documento" },
                identificationNumber: { id: "form-checkout__identificationNumber", placeholder: "N√∫mero del documento" },
                cardholderEmail: { id: "form-checkout__cardholderEmail", placeholder: "E-mail" },
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) {
                        console.error("‚ùå Error mounting cardForm:", error);
                        showError('Error al cargar el formulario de pago');
                    } else {
                        console.log('‚úÖ Formulario montado correctamente');
                        showSuccess('Formulario listo - puedes escribir en los campos');
                    }
                },
                onSubmit: event => {
                    event.preventDefault();
                    console.log('üîÑ Procesando pago...');

                    try {
                        const formData = cardForm.getCardFormData();
                        const {
                            paymentMethodId: payment_method_id,
                            issuerId: issuer_id,
                            cardholderEmail: email,
                            amount,
                            token,
                            installments,
                            identificationNumber,
                            identificationType,
                        } = formData;

                        if (!token) {
                            showError('‚ùå No se pudo generar el token de la tarjeta');
                            return;
                        }

                        const submitButton = document.getElementById('form-checkout__submit');
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                        const paymentData = {
                            token,
                            issuer_id,
                            payment_method_id,
                            transaction_amount: Number(amount),
                            installments: Number(installments),
                            description: "Pago para evento {{ contratacion.evento.titulo if contratacion else 'Evento' }}",
                            payer: {
                                email,
                                identification: {
                                    type: identificationType,
                                    number: identificationNumber,
                                },
                            },
                        };

                        fetch("/pagos/procesar/{{ contratacion.id if contratacion else 0 }}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(paymentData),
                        })
                        .then(response => response.json())
                        .then(result => {
                            console.log("üì• Resultado:", result);
                            
                            if (result.success) {
                                showSuccess("‚úÖ ¬°Pago procesado exitosamente!");
                                setTimeout(() => {
                                    window.location.href = "/pagos/exito/" + result.pago_id;
                                }, 2000);
                            } else {
                                showError("‚ùå Error: " + result.message);
                                submitButton.disabled = false;
                                submitButton.innerHTML = '<i class="fas fa-credit-card"></i> Pagar ${{ "%.2f"|format(contratacion.precio_total if contratacion else total) }}';
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Error:', error);
                            showError('‚ùå Error de conexi√≥n: ' + error.message);
                            submitButton.disabled = false;
                            submitButton.innerHTML = '<i class="fas fa-credit-card"></i> Pagar ${{ "%.2f"|format(contratacion.precio_total if contratacion else total) }}';
                        });

                    } catch (error) {
                        console.error('‚ùå Error en onSubmit:', error);
                        showError('‚ùå Error al procesar el formulario: ' + error.message);
                    }
                },
                onFetching: (resource) => {
                    console.log("üîÑ Fetching resource: ", resource);
                }
            },
        });

        console.log('‚úÖ CardForm configurado');

    } catch (error) {
        console.error('‚ùå Error inicializando MercadoPago:', error);
        showError('Error al inicializar MercadoPago: ' + error.message);
    }
});
</script>
{% endblock %}